<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Universal Share (Debug Mode)</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; text-align: center; padding: 20px; background-color: #f0f2f5; color: #333; }
        h1 { color: #007bff; margin-bottom: 10px; }
        
        /* Area Status e Log */
        #status-box { background: #fff; border: 1px solid #ccc; padding: 15px; border-radius: 8px; margin-bottom: 20px; text-align: left; font-family: monospace; font-size: 0.9em; min-height: 60px; word-break: break-all; }
        .log-entry { margin: 2px 0; border-bottom: 1px solid #eee; padding-bottom: 2px; }
        .error { color: red; font-weight: bold; }
        .success { color: green; font-weight: bold; }

        .box { background: white; padding: 25px; margin: 0 auto; max-width: 500px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .hidden { display: none; }
        
        /* QR e Link */
        #qrcode { display: flex; justify-content: center; margin: 20px 0; }
        input[type="text"] { width: 90%; padding: 10px; font-size: 14px; border: 1px solid #ddd; border-radius: 5px; background: #f9f9f9; color: #555; }
        
        button { background-color: #007bff; color: white; border: none; padding: 12px 20px; border-radius: 6px; font-size: 16px; cursor: pointer; margin-top: 10px; width: 100%; transition: background 0.2s; }
        button:hover { background-color: #0056b3; }
        button.secondary { background-color: #6c757d; }
        
        /* Area File */
        #incoming-files { margin-top: 20px; text-align: left; }
        .file-card { background: #e9ecef; padding: 10px; margin-top: 8px; border-radius: 6px; display: flex; justify-content: space-between; align-items: center; }
    </style>
</head>
<body>

    <h1>üåê Share Plus Debug</h1>
    
    <!-- Area Log Visibile -->
    <div id="status-box">
        <div><strong>Stato Sistema:</strong></div>
        <div id="logs">Inizializzazione...</div>
    </div>

    <!-- PANNELLO HOST -->
    <div id="host-panel" class="hidden box">
        <h3>1. Fai scansionare o invia il link</h3>
        <div id="qrcode"></div>
        
        <p>Link diretto (Copia e invia):</p>
        <input type="text" id="linkUrl" readonly onclick="this.select()">
        <button onclick="copyLink()" class="secondary">Copia Link üìã</button>
        
        <p style="margin-top: 20px; font-size: 0.8em; color: #888;">Lascia questa pagina aperta finch√© non si connette.</p>
    </div>

    <!-- PANNELLO CLIENT (Mentre si connette) -->
    <div id="client-loader" class="hidden box">
        <h3>Tentativo di connessione...</h3>
        <p>Sto provando a bucare il NAT (STUN/TURN).</p>
        <div class="loader">‚è≥</div>
    </div>

    <!-- PANNELLO TRASFERIMENTO -->
    <div id="transfer-panel" class="hidden box">
        <h3 class="success">‚úÖ Connesso!</h3>
        <p>Tunnel P2P attivo.</p>
        
        <input type="file" id="fileInput">
        <button onclick="sendFile()">Invia File üì§</button>
        
        <hr>
        <h4>File Ricevuti:</h4>
        <div id="incoming-files"></div>
    </div>

    <script>
        // Funzione per scrivere a schermo i log (cos√¨ mi puoi dire cosa vedi)
        function log(msg, type = 'info') {
            const logsDiv = document.getElementById('logs');
            const entry = document.createElement('div');
            entry.className = 'log-entry ' + type;
            // Aggiungo orario per capire i tempi
            const time = new Date().toLocaleTimeString();
            entry.innerText = `[${time}] ${msg}`;
            logsDiv.prepend(entry); // I nuovi messaggi vanno in alto
        }

        const peerConfig = {
            debug: 2,
            config: {
                iceServers: [
                    { urls: 'stun:stun.l.google.com:19302' },
                    // TURN gratuito OpenRelay
                    {
                        urls: "turn:openrelay.metered.ca:80",
                        username: "openrelayproject",
                        credential: "openrelayproject"
                    },
                    {
                        urls: "turn:openrelay.metered.ca:443",
                        username: "openrelayproject",
                        credential: "openrelayproject"
                    },
                    {
                        urls: "turn:openrelay.metered.ca:443?transport=tcp",
                        username: "openrelayproject",
                        credential: "openrelayproject"
                    }
                ]
            }
        };

        let peer = null;
        let conn = null;

        const urlParams = new URLSearchParams(window.location.search);
        const remoteId = urlParams.get('id');

        // Avvio
        if (remoteId) {
            initPeer(null); 
        } else {
            const myId = "h-" + Math.floor(Math.random() * 100000);
            initPeer(myId);
        }

        function initPeer(id) {
            log("Creo istanza PeerJS...");
            peer = new Peer(id, peerConfig);

            peer.on('open', (myId) => {
                log("ID Peer creato: " + myId, 'success');
                
                if (!remoteId) {
                    // --- HOST ---
                    document.getElementById('host-panel').classList.remove('hidden');
                    
                    const fullUrl = window.location.href.split('?')[0] + '?id=' + myId;
                    
                    // Genera QR
                    new QRCode(document.getElementById("qrcode"), {
                        text: fullUrl,
                        width: 160,
                        height: 160
                    });
                    
                    // Riempi input link
                    document.getElementById('linkUrl').value = fullUrl;

                    log("In attesa di connessioni...");
                    peer.on('connection', (connection) => {
                        log("Qualcuno sta provando a connettersi...");
                        setupConnection(connection);
                    });

                } else {
                    // --- CLIENT ---
                    document.getElementById('client-loader').classList.remove('hidden');
                    log("Provo a connettermi all'Host: " + remoteId);
                    
                    const connection = peer.connect(remoteId, {
                        reliable: true
                    });
                    setupConnection(connection);
                }
            });

            peer.on('error', (err) => {
                log("ERRORE PEER: " + err.type, 'error');
                console.error(err);
            });
            
            peer.on('disconnected', () => {
                log("Disconnesso dal server di signaling (riprovo...)", 'error');
                peer.reconnect();
            });
        }

        function setupConnection(connection) {
            conn = connection;

            // Monitoraggio stato ICE (Importantissimo per te)
            peer.on('iceStateChanged', (state) => {
                log("Stato ICE Router: " + state);
                // checking -> connected -> completed (Vittoria)
                // checking -> disconnected/failed (Errore NAT)
            });

            conn.on('open', () => {
                log("‚úÖ TUNNEL DATI APERTO!", 'success');
                document.getElementById('host-panel').classList.add('hidden');
                document.getElementById('client-loader').classList.add('hidden');
                document.getElementById('transfer-panel').classList.remove('hidden');
            });

            conn.on('data', (data) => {
                log("Dati ricevuti: " + (data.name || 'blob'));
                if (data.file && data.name) handleReceivedFile(data);
            });

            conn.on('close', () => {
                log("Connessione chiusa dall'altro utente.", 'error');
                alert("Connessione persa.");
            });
            
            conn.on('error', (err) => {
                log("Errore Connessione: " + err, 'error');
            });
        }

        function sendFile() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            if (!file) return alert("Scegli un file");
            
            log("Invio in corso: " + file.name + " (" + file.size + " bytes)");
            
            const reader = new FileReader();
            reader.onload = (e) => {
                const blob = new Blob([new Uint8Array(e.target.result)], {type: file.type});
                conn.send({ file: blob, name: file.name, type: file.type });
                log("File inviato.", 'success');
            };
            reader.readAsArrayBuffer(file);
        }

        function handleReceivedFile(data) {
            const blob = new Blob([data.file], { type: data.type });
            const url = URL.createObjectURL(blob);
            
            const div = document.getElementById('incoming-files');
            div.innerHTML += `
                <div class="file-card">
                    <span>üìÑ ${data.name}</span>
                    <a href="${url}" download="${data.name}"><button class="secondary">Scarica</button></a>
                </div>
            `;
        }

        function copyLink() {
            const copyText = document.getElementById("linkUrl");
            copyText.select();
            copyText.setSelectionRange(0, 99999); 
            navigator.clipboard.writeText(copyText.value).then(() => {
                alert("Link copiato!");
            });
        }
    </script>
</body>
</html>
